services:
  gateway:
    image: nginx:1.29-alpine
    volumes:
      - ./nginx.dev.conf:/etc/nginx/conf.d/default.conf
    ports:
      - 18288:3000
    depends_on:
      - frontend
      - server

  server:
    build:
      context: .
      target: dev
    working_dir: /usr/local/todo-app
    environment:
      DATABASE__HOST: database
      DATABASE__DATABASE: todo_app_dev
      DATABASE__USER: root
      DATABASE__PASS: password
      DATABASE__TEST_DATABASE: todo_app_test
    ports:
      - 13034:3000
      - 52004:42004
    volumes:
      - .:/usr/local/todo-app
      - maven:/root/.m2
    command: clojure -M:api:test:repl
    depends_on:
      database:
        condition: service_healthy

  # 初期化専用サービス
  # frontend起動前にweb/targetを確実にクリーンアップする
  init-cleanup:
    build:
      context: .
      target: dev
    working_dir: /usr/local/todo-app
    volumes:
      - .:/usr/local/todo-app
    command: sh -c "rm -rf web/target && echo '[init-cleanup] Success!'"

  frontend:
    build:
      context: .
      target: dev
    working_dir: /usr/local/todo-app
    ports:
      - 18280:3000
      - 9630:9630
      - 9631:9631
    healthcheck:
      test: 'test -f web/target/.first-build-completed'
      start_period: 120s
      interval: 10s
      timeout: 2s
      retries: 3
    volumes:
      - .:/usr/local/todo-app
      - maven:/root/.m2
      - node_modules:/usr/local/todo-app/node_modules
    command: yarn dev
    depends_on:
      init-cleanup:
        condition: service_completed_successfully

  database:
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: todo_app_dev
      POSTGRES_USER: root
      POSTGRES_PASSWORD: password
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U root -d todo_app_dev"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - database:/var/lib/postgresql/data
    ports:
      - 64320:5432

volumes:
  database:
  maven:
  node_modules:
